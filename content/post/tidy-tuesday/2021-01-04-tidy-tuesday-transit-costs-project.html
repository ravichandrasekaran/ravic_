---
title: 'Tidy Tuesday: Transit Costs Project'
author: ravic
date: '2021-01-04'
slug: tidy-tuesday-transit-costs-project
categories: []
tags:
  - tidy-tuesday
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>A #tidytuesday for transit costs.</p>
<!--more-->
<p>A #tidytuesday for transit costs.</p>
<pre class="r"><code>train %&gt;%
  filter(stations &gt; 0,
         real_cost &gt; 0,
         tunnel_complete_ind) %&gt;%
  ggplot(aes(stations, real_cost)) +
  geom_point(alpha=.2) + 
  geom_smooth(formula=y ~ x, method=&quot;loess&quot;, se=TRUE) +
  scale_x_continuous(trans=&quot;log1p&quot;, breaks=seq(10, 60, 10)) +
  scale_y_continuous(trans=&quot;log1p&quot;, breaks=10 ^ seq(2, 5)) +
  coord_cartesian(xlim=c(1, 50)) +
  labs(title=&quot;Relationship between real cost and stations&quot;, 
       y = &quot;Real cost&quot;,
       x = &quot;Stations&quot;)</code></pre>
<p><img src="/post/tidy-tuesday/2021-01-04-tidy-tuesday-transit-costs-project_files/figure-html/plot-stations-tunnels-1.png" width="672" /></p>
<pre class="r"><code>train %&gt;%
  filter(tunnel &gt; 0,
         real_cost &gt; 0,
         tunnel_complete_ind) %&gt;%
  ggplot(aes(tunnel, real_cost)) +
  geom_point(alpha=.2) + 
  geom_smooth(formula=y ~ x, method=&quot;loess&quot;, se=TRUE) +
  scale_x_continuous(trans=&quot;log1p&quot;, breaks=seq(10, 60, 10)) +
  scale_y_continuous(trans=&quot;log1p&quot;, breaks=10 ^ seq(2, 5)) +
  coord_cartesian(xlim=c(1, 50)) +
  labs(title=&quot;Relationship between real cost and tunnels&quot;, 
       y = &quot;Real cost&quot;,
       x = &quot;Tunnels&quot;)</code></pre>
<p><img src="/post/tidy-tuesday/2021-01-04-tidy-tuesday-transit-costs-project_files/figure-html/plot-stations-tunnels-2.png" width="672" /></p>
<pre class="r"><code>country_primed &lt;- train %&gt;%
  filter(tunnel_complete_ind,
         real_cost &gt; 0) %&gt;%
  mutate(country_name = fct_lump(country_name, n=10)) %&gt;%
  group_by(country_name) %&gt;%  
  summarise(geom_mean_cost = exp(mean(log(real_cost + 1))),
            .groups = &quot;drop&quot;)

train %&gt;%
  filter(tunnel_complete_ind,
         real_cost &gt; 0) %&gt;%
  mutate(country_name = fct_lump(country_name, n=10)) %&gt;%
  left_join(country_primed, by = &quot;country_name&quot;) %&gt;%
  mutate(country_name = fct_reorder(country_name, geom_mean_cost)) %&gt;%
  mutate(country_name = fct_relevel(country_name, &quot;Other&quot;)) %&gt;%
  ggplot(aes(real_cost, country_name)) +
  geom_point(alpha=.3) +
  geom_point(data = country_primed, aes(x=geom_mean_cost), color=&quot;blue&quot;, shape=4, size=2) +
  scale_x_log10() + 
  labs(title = &quot;Real cost by country&quot;,
       y = NULL,
       x = NULL)</code></pre>
<p><img src="/post/tidy-tuesday/2021-01-04-tidy-tuesday-transit-costs-project_files/figure-html/country-plot-1.png" width="672" /></p>
<pre class="r"><code>library(&quot;tidymodels&quot;)

linear_mod &lt;- linear_reg() %&gt;%
  set_engine(&quot;lm&quot;)

transit_recipe &lt;- 
  recipe(log_real_cost ~ entry + length + duration + country_name + tunnel, 
         data = train) %&gt;%
  update_role(entry, new_role=&quot;id&quot;) %&gt;%
  step_filter(tunnel &gt; 0, skip=FALSE) %&gt;%
  step_naomit(duration, tunnel, country_name, length) %&gt;%
  step_log(tunnel) %&gt;%
  step_other(country_name, threshold = 10) %&gt;%
  prep()

transit_workflow &lt;- workflow() %&gt;%
  add_recipe(transit_recipe) %&gt;%
  add_model(linear_mod) 

baked_train &lt;- transit_recipe %&gt;%
  bake(new_data = train)

fitted_workflow &lt;- transit_workflow %&gt;%
  fit(data=train)</code></pre>
<pre class="r"><code>library(&quot;broom&quot;)

options(scipen=0)
options(digits=3)

fitted_transit_linear &lt;- fitted_workflow %&gt;%
  pull_workflow_fit() %&gt;%
  pluck(&quot;fit&quot;)
broom::tidy(fitted_transit_linear)</code></pre>
<pre><code>## # A tibble: 5 x 5
##   term              estimate std.error statistic  p.value
##   &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)         4.99      0.249     20.0   1.76e-30
## 2 length              0.0120    0.0157     0.763 4.48e- 1
## 3 duration            0.102     0.0311     3.27  1.66e- 3
## 4 country_nameother  -0.382     0.208     -1.84  7.07e- 2
## 5 tunnel              0.843     0.166      5.08  3.10e- 6</code></pre>
<pre class="r"><code>broom::glance(fitted_transit_linear)</code></pre>
<pre><code>## # A tibble: 1 x 12
##   r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
##       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     0.798         0.786 0.581      68.0 3.29e-23     4  -62.3  137.  150.
## # … with 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
<pre class="r"><code>augmented &lt;- broom::augment(fitted_transit_linear)</code></pre>
<pre class="r"><code>library(&quot;ggfortify&quot;)

autoplot(fitted_transit_linear, alpha=.2, which=1:6) +
  theme_light() +
  theme(legend.position = &quot;none&quot;) </code></pre>
<p><img src="/post/tidy-tuesday/2021-01-04-tidy-tuesday-transit-costs-project_files/figure-html/residuals-outliers-1.png" width="672" /></p>
<pre class="r"><code>baked_train %&gt;%
  left_join(train, by=&quot;entry&quot;) %&gt;% 
  slice(c(33, 73, 55, 20, 57)) </code></pre>
<pre><code>## # A tibble: 5 x 29
##   entry length.x duration.x country_name.x tunnel.x log_real_cost.x country_code
##   &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt; &lt;fct&gt;             &lt;dbl&gt;           &lt;dbl&gt; &lt;fct&gt;       
## 1  7408     1.6           7 other             0.470            7.78 US          
## 2  8210     4.3           6 other             1.46             8.01 EG          
## 3  7627     5.35          9 other             1.68             5.63 TR          
## 4  7281    41.9           9 other             3.74            10.1  SG          
## 5  7633     9.22         14 other             2.22             7.00 TR          
## # … with 22 more variables: city &lt;chr&gt;, line &lt;chr&gt;, start_year &lt;dbl&gt;,
## #   end_year &lt;dbl&gt;, length.y &lt;dbl&gt;, tunnel.y &lt;dbl&gt;, stations &lt;dbl&gt;,
## #   source1 &lt;fct&gt;, cost &lt;dbl&gt;, currency_code &lt;fct&gt;, year &lt;dbl&gt;, ppp_rate &lt;dbl&gt;,
## #   real_cost &lt;dbl&gt;, cost_km_millions &lt;dbl&gt;, source2 &lt;fct&gt;, reference &lt;chr&gt;,
## #   railroad_ind &lt;lgl&gt;, tunnel_complete_ind &lt;lgl&gt;, country_name.y &lt;fct&gt;,
## #   duration.y &lt;dbl&gt;, hostname &lt;chr&gt;, log_real_cost.y &lt;dbl&gt;</code></pre>
<pre class="r"><code>library(&quot;tidymodels&quot;)

baked_test &lt;- transit_recipe %&gt;%
  bake(new_data = test)

predictions &lt;-
  fitted_workflow %&gt;%
  predict(new_data=test) %&gt;%
  rename(prediction = .pred) %&gt;%
  bind_cols(baked_test %&gt;% select(log_real_cost)) %&gt;%
  filter(is.finite(prediction)) %&gt;%
  mutate(across(c(prediction, log_real_cost), exp))

eval_metrics &lt;- metric_set(rmse, rsq)
eval_metrics(predictions, truth=log_real_cost, estimate=prediction)</code></pre>
<pre><code>## # A tibble: 2 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 rmse    standard    1342.   
## 2 rsq     standard       0.799</code></pre>
<pre class="r"><code>options(scipen=0)
final_fitted_lm &lt;- transit_workflow %&gt;%
  fit(data = df) %&gt;%
  pull_workflow_fit() %&gt;%
  pluck(&quot;fit&quot;) 
final_fitted_lm %&gt;%
  tidy(conf.int = TRUE)</code></pre>
<pre><code>## # A tibble: 5 x 7
##   term              estimate std.error statistic  p.value conf.low conf.high
##   &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)        5.01       0.238     21.1   1.08e-35   4.54      5.48  
## 2 length             0.00665    0.0134     0.496 6.21e- 1  -0.0200    0.0333
## 3 duration           0.100      0.0288     3.47  8.20e- 4   0.0427    0.157 
## 4 country_nameother -0.361      0.197     -1.84  6.99e- 2  -0.752     0.0300
## 5 tunnel             0.877      0.152      5.78  1.15e- 7   0.576     1.18</code></pre>
<pre class="r"><code>final_fitted_lm %&gt;%
  autoplot(., alpha=.2, which=c(1, 2, 4, 6)) +
  theme_light() +
  theme(legend.position = &quot;none&quot;) </code></pre>
<p><img src="/post/tidy-tuesday/2021-01-04-tidy-tuesday-transit-costs-project_files/figure-html/final-linear-model-1.png" width="672" /></p>
<pre class="r"><code>augmented &lt;- broom::augment(final_fitted_lm)
baked_df &lt;- transit_recipe %&gt;%
  bake(new_data=df)


augmented %&gt;%
  bind_cols(baked_df %&gt;% select(entry)) %&gt;%
  select(entry, starts_with(&quot;.&quot;)) %&gt;%
  left_join(df %&gt;% select(-length, -duration, -country_name, -tunnel, -length), by=&quot;entry&quot;) %&gt;%
  filter(.std.resid &gt; 2) </code></pre>
<pre><code>## # A tibble: 4 x 27
##   entry   ..y .fitted .resid .std.resid   .hat .sigma .cooksd country_code city 
##   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;        &lt;chr&gt;
## 1  7178  8.10    6.83   1.26       2.15 0.0314  0.585  0.0300 PL           Wars…
## 2  7408  7.78    5.77   2.01       3.47 0.0568  0.557  0.145  US           New …
## 3  7409  8.40    6.44   1.96       3.37 0.0480  0.560  0.114  US           New …
## 4  8210  8.01    6.56   1.45       2.45 0.0175  0.580  0.0213 EG           Cairo
## # … with 17 more variables: line &lt;chr&gt;, start_year &lt;dbl&gt;, end_year &lt;dbl&gt;,
## #   stations &lt;dbl&gt;, source1 &lt;fct&gt;, cost &lt;dbl&gt;, currency_code &lt;fct&gt;, year &lt;dbl&gt;,
## #   ppp_rate &lt;dbl&gt;, real_cost &lt;dbl&gt;, cost_km_millions &lt;dbl&gt;, source2 &lt;fct&gt;,
## #   reference &lt;chr&gt;, railroad_ind &lt;lgl&gt;, tunnel_complete_ind &lt;lgl&gt;,
## #   hostname &lt;chr&gt;, log_real_cost &lt;dbl&gt;</code></pre>
<pre class="r"><code>baked_df %&gt;%
  slice(c(39, 40, 90)) %&gt;%
  select(entry) %&gt;%
  left_join(df, by=&quot;entry&quot;)</code></pre>
<pre><code>## # A tibble: 3 x 24
##   entry country_code city  line  start_year end_year length tunnel stations
##   &lt;dbl&gt; &lt;fct&gt;        &lt;chr&gt; &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
## 1  7408 US           New … 7 ex…       2007     2014    1.6    1.6        1
## 2  7409 US           New … Seco…       2007     2016    2.7    2.7        3
## 3  8210 EG           Cairo Line…       2006     2012    4.3    4.3        5
## # … with 15 more variables: source1 &lt;fct&gt;, cost &lt;dbl&gt;, currency_code &lt;fct&gt;,
## #   year &lt;dbl&gt;, ppp_rate &lt;dbl&gt;, real_cost &lt;dbl&gt;, cost_km_millions &lt;dbl&gt;,
## #   source2 &lt;fct&gt;, reference &lt;chr&gt;, railroad_ind &lt;lgl&gt;,
## #   tunnel_complete_ind &lt;lgl&gt;, country_name &lt;fct&gt;, duration &lt;dbl&gt;,
## #   hostname &lt;chr&gt;, log_real_cost &lt;dbl&gt;</code></pre>
<pre class="r"><code>library(&quot;FactoMineR&quot;)
numerics &lt;- df %&gt;%
  select(where(is.numeric) | city, -ends_with(&quot;_year&quot;), -cost, -ppp_rate, -year, 
         -log_real_cost, -cost_km_millions) %&gt;%
  mutate(across(c(tunnel, real_cost, stations), log1p)) %&gt;%
  filter(complete.cases(.))

pca_result &lt;- prcomp(numerics %&gt;% select(-entry, -city), 
                     center = TRUE, scale. = TRUE, retx = TRUE)
numerics &lt;- numerics %&gt;%
  bind_cols(as_tibble(pca_result$x))
numerics %&gt;%
  ggplot(aes(PC1, PC2)) + 
  geom_point(alpha=.8) + 
  gghighlight::gghighlight(city == &quot;New York&quot;)</code></pre>
<p><img src="/post/tidy-tuesday/2021-01-04-tidy-tuesday-transit-costs-project_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<pre class="r"><code>autoplot(pca_result, alpha=.3)</code></pre>
<p><img src="/post/tidy-tuesday/2021-01-04-tidy-tuesday-transit-costs-project_files/figure-html/unnamed-chunk-1-2.png" width="672" /></p>
<pre class="r"><code>duration_model &lt;- df %&gt;%
  filter(end_year &lt; 2020,
         complete.cases(.)) %&gt;%
  mutate(country_name = fct_lump(country_name, n = 10)) %&gt;%
  lm(duration ~ log1p(stations) + length + country_name, data=.) 

duration_model %&gt;%
  broom::glance() </code></pre>
<pre><code>## # A tibble: 1 x 12
##   r.squared adj.r.squared sigma statistic p.value    df logLik   AIC   BIC
##       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     0.545         0.474  1.98      7.69 3.72e-9    12  -182.  392.  427.
## # … with 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
<pre class="r"><code>duration_model %&gt;%
  autoplot(., alpha=.4) +
  theme_light() </code></pre>
<p><img src="/post/tidy-tuesday/2021-01-04-tidy-tuesday-transit-costs-project_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>df %&gt;%
  filter(end_year &lt; 2020,
         complete.cases(.)) %&gt;%
  slice(c(35, 66, 30))</code></pre>
<pre><code>## # A tibble: 3 x 24
##   entry country_code city  line  start_year end_year length tunnel stations
##   &lt;dbl&gt; &lt;fct&gt;        &lt;chr&gt; &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
## 1  7395 FR           Paris Line…       1993     2007   9.2    9.2         9
## 2  7633 TR           Anka… M4          2003     2017   9.22   9.22        9
## 3  7371 IR           Tehr… Line…       2012     2014  12     12          11
## # … with 15 more variables: source1 &lt;fct&gt;, cost &lt;dbl&gt;, currency_code &lt;fct&gt;,
## #   year &lt;dbl&gt;, ppp_rate &lt;dbl&gt;, real_cost &lt;dbl&gt;, cost_km_millions &lt;dbl&gt;,
## #   source2 &lt;fct&gt;, reference &lt;chr&gt;, railroad_ind &lt;lgl&gt;,
## #   tunnel_complete_ind &lt;lgl&gt;, country_name &lt;fct&gt;, duration &lt;dbl&gt;,
## #   hostname &lt;chr&gt;, log_real_cost &lt;dbl&gt;</code></pre>
